<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sangraha - Smart Recipe Kit</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome CDN (for icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

        :root {
            --primary: #10b981;
            --primary-dark: #059669;
            --secondary: #f59e0b;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8fafc;
        }

        .hero-gradient {
            background: linear-gradient(135deg, #10b981 0%, #3b82f6 100%);
        }

        .gradient-text {
            background: linear-gradient(90deg, #10b981, #3b82f6);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .slide-up {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.4s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Custom Modal for Alerts/Confirmations -->
    <div id="customModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center border-2" id="customModalContent">
            <p class="text-lg font-semibold mb-4" id="customModalMessage"></p>
            <button onclick="closeCustomModal()" class="px-4 py-2 rounded-md font-semibold text-white transition duration-200" id="customModalCloseBtn">
                OK
            </button>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-root" class="flex-grow flex flex-col">
        <!-- Content will be rendered here by JavaScript -->
    </div>

    <!-- App Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t shadow-md z-30">
        <div class="flex justify-around max-w-md mx-auto">
            <button id="navHomeBtn" class="flex flex-col items-center justify-center py-3 px-6 text-gray-500 hover:text-green-500 transition text-xs">
                <i class="fas fa-home text-xl mb-1"></i>
                <span>Home</span>
            </button>
            <button id="navDiscoverBtn" class="flex flex-col items-center justify-center py-3 px-6 text-gray-500 hover:text-green-500 transition text-xs">
                <i class="fas fa-search text-xl mb-1"></i>
                <span>Discover</span>
            </button>
            <button id="navAlertsBtn" class="flex flex-col items-center justify-center py-3 px-6 text-gray-500 hover:text-green-500 transition text-xs">
                <i class="fas fa-bell text-xl mb-1"></i>
                <span>Alerts</span>
            </button>
            <button id="navProfileBtn" class="flex flex-col items-center justify-center py-3 px-6 text-gray-500 hover:text-green-500 transition text-xs">
                <i class="fas fa-user text-xl mb-1"></i>
                <span>Profile</span>
            </button>
            <button id="navAdminBtn" class="flex flex-col items-center justify-center py-3 px-6 text-gray-500 hover:text-green-500 transition text-xs">
                <i class="fas fa-user-shield text-xl mb-1"></i>
                <span>Admin</span>
            </button>
        </div>
    </nav>

    <!-- Firebase SDKs and Application Logic -->
    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables (will be provided by Canvas environment or set locally for testing)
        // For local testing, replace these with your actual Firebase config
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            // IMPORTANT: The following values have been updated with your provided Firebase configuration.
            // These are used if the Canvas environment variables (__firebase_config) are not available.
            apiKey: "AIzaSyAvbSX9NeWhfgd333rtdPl0qaY1xz8YM2Q",
            authDomain: "sangraha-34d0e.firebaseapp.com",
            projectId: "sangraha-34d0e",
            storageBucket: "sangraha-34d0e.firebasestorage.app",
            messagingSenderId: "790328804204",
            appId: "1:790328804204:web:59c4afde4b3f10a368a949",
            measurementId: "G-CFQ2B1BYH9"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId || 'default-app-id'; // Use projectId as appId for local
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        let app, db, auth;
        let userId = null; // Declare userId globally
        let currentPage = 'home'; // Declare currentPage globally and initialize

        // Mock data for recipes and ingredients (for demonstration purposes)
        const recipesDatabase = {
            "panipuri": {
                name: "Panipuri",
                image: "https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/031b6a91-2d3a-437a-8a6c-9cba3a1fbc19.png",
                description: "Crispy hollow puris filled with spicy, tangy water and flavorful fillings",
                baseServings: 100, // Base for 100 plates
                profitPerPlate: 25,
                ingredients: [
                    {
                        id: "puri",
                        name: "Puri",
                        description: "Crispy hollow puris",
                        image: "https://storage.googleapis.com/workspace-0f70711f-8b4e-4d28-b644-4743b55ee0eb.png",
                        quantityPerServing: 100, // 100 puris per 100 plates
                        brands: [
                            { id: "puri1", name: "Haldiram's Ready-to-Fry Puri", weight: "200g (approx 50 puris)", price: 45, marketPrice: 60, rating: 4.5, reviews: 124, store: "Amazon", delivery: "2h", image: "https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/227f1b4c-10b1-4717-b22d-49869e9c0166.png" },
                            { id: "puri2", name: "MTR Panipuri Puri", weight: "150g (approx 40 puris)", price: 35, marketPrice: 50, rating: 4.2, reviews: 78, store: "BigBasket", delivery: "1h", image: "https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/f06447b9-e7b9-414d-aff2-4e07daafa567.png" },
                            { id: "puri3", name: "Local Halwai Fresh Puri", weight: "250g (approx 60 puris)", price: 30, marketPrice: 40, rating: 4.7, reviews: 215, store: "Local Store", delivery: "30m", image: "https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/55fd7ea1-2365-45fd-b591-4b57bf89b081.png" }
                        ]
                    },
                    {
                        id: "onion",
                        name: "Onion",
                        description: "Fresh onions for stuffing",
                        image: "https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/385bf525-adfa-4b86-a9f7-ae4be52863fb.png",
                        quantityPerServing: 0.5, // 0.5kg per 100 plates
                        brands: [
                            { id: "onion1", name: "Organic Red Onions", weight: "1kg", price: 60, marketPrice: 80, rating: 4.3, reviews: 56, store: "BigBasket", delivery: "1h", image: "https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/cfe6e2b2-09e9-481f-9539-99e409f4a5ca.png" },
                            { id: "onion2", name: "Fresh Local Onions", weight: "1kg", price: 40, marketPrice: 50, rating: 4.1, reviews: 32, store: "Local Vendor", delivery: "30m", image: "https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/a239720c-40bf-406e-91df-d1470a3b39fb.png" }
                        ]
                    },
                    {
                        id: "potato",
                        name: "Potato",
                        description: "Boiled potatoes for stuffing",
                        image: "https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/699ae891-2252-459f-a031-e660da96fb8c.png",
                        quantityPerServing: 0.75, // 0.75kg per 100 plates
                        brands: [
                            { id: "potato1", name: "Fresh Farm Potatoes", weight: "1kg", price: 35, marketPrice: 45, rating: 4.0, reviews: 42, store: "BigBasket", delivery: "1h", image: "https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/e9056a59-06c1-497d-8203-31a0c27c3f99.png" }
                        ]
                    },
                    {
                        id: "tamarind",
                        name: "Tamarind",
                        description: "For making tangy water",
                        image: "https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/45c927f3-2bdb-4d5d-8a01-478f5f76d02a.png",
                        quantityPerServing: 0.1, // 0.1kg per 100 plates
                        brands: [
                            { id: "tamarind1", name: "24 Mantra Organic Tamarind", weight: "200g", price: 85, marketPrice: 110, rating: 4.6, reviews: 67, store: "Amazon", delivery: "2h", image: "https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/d862db4d-0f9e-4727-a8b5-6fb791d6592c.png" },
                            { id: "tamarind2", name: "Local Market Tamarind", weight: "250g", price: 50, marketPrice: 70, rating: 4.2, reviews: 23, store: "Local Store", delivery: "30m", image: "https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/49826417-cef4-408d-8185-f6f74ea0cbcf.png" }
                        ]
                    },
                    {
                        id: "aamchur",
                        name: "Aamchur Powder",
                        description: "Dried mango powder for tanginess",
                        image: "https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/3b1ca055-0002-48c8-b628-4780dccaf0be.png",
                        quantityPerServing: 0.05, // 0.05kg per 100 plates
                        brands: [
                            { id: "aamchur1", name: "Everest Aamchur Powder", weight: "100g", price: 45, marketPrice: 60, rating: 4.4, reviews: 89, store: "Amazon", delivery: "2h", image: "https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/4d835aa2-8d41-4685-85e6-7df3a95cba3d.png" }
                        ]
                    },
                    {
                        id: "salt",
                        name: "Salt",
                        description: "Essential seasoning",
                        image: "https://placehold.co/100x100/AEC6CF/000000?text=Salt",
                        quantityPerServing: 0.02, // 0.02kg per 100 plates
                        brands: [
                            { id: "salt1", name: "Tata Salt", weight: "1kg", price: 25, marketPrice: 30, rating: 4.8, reviews: 500, store: "Local Store", delivery: "30m", image: "https://placehold.co/100x100/AEC6CF/000000?text=Tata+Salt" }
                        ]
                    },
                    {
                        id: "coriander",
                        name: "Coriander Leaves",
                        description: "Fresh garnish",
                        image: "https://placehold.co/100x100/AEC6CF/000000?text=Coriander",
                        quantityPerServing: 0.01, // 0.01kg per 100 plates
                        brands: [
                            { id: "coriander1", name: "Fresh Coriander", weight: "100g", price: 10, marketPrice: 15, rating: 4.5, reviews: 150, store: "Local Vendor", delivery: "30m", image: "https://placehold.co/100x100/AEC6CF/000000?text=Fresh+Coriander" }
                        ]
                    }
                ]
            },
            "biryani": {
                name: "Chicken Biryani",
                image: "https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/29705d98-f809-408a-9859-539f967e5acb.png",
                description: "Aromatic rice dish with chicken and spices",
                baseServings: 4, // Base for 4 plates
                profitPerPlate: 100,
                ingredients: [
                    {
                        id: "rice",
                        name: "Basmati Rice",
                        description: "Long grain rice",
                        image: "https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/15b30d3f-bcd9-4b12-a246-91d89f124d1b.png",
                        quantityPerServing: 0.5, // 0.5kg per 4 plates
                        brands: [
                            { id: "rice1", name: "India Gate Basmati Rice", weight: "1kg", price: 150, marketPrice: 180, rating: 4.7, reviews: 342, store: "BigBasket", delivery: "1h", image: "https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/fcbed799-e245-4056-9aa8-5127fac09dc2.png" }
                        ]
                    },
                    {
                        id: "chicken",
                        name: "Chicken",
                        description: "Fresh chicken pieces",
                        image: "https://placehold.co/100x100/AEC6CF/000000?text=Chicken",
                        quantityPerServing: 0.75, // 0.75kg per 4 plates
                        brands: [
                            { id: "chicken1", name: "Fresh Chicken Cuts", weight: "1kg", price: 280, marketPrice: 350, rating: 4.6, reviews: 200, store: "Local Butcher", delivery: "1h", image: "https://placehold.co/100x100/AEC6CF/000000?text=Chicken" }
                        ]
                    },
                    {
                        id: "biryani_masala",
                        name: "Biryani Masala",
                        description: "Blend of spices for biryani",
                        image: "https://placehold.co/100x100/AEC6CF/000000?text=Biryani+Masala",
                        quantityPerServing: 0.05, // 0.05kg per 4 plates
                        brands: [
                            { id: "biryani_masala1", name: "MDH Biryani Masala", weight: "100g", price: 70, marketPrice: 90, rating: 4.4, reviews: 180, store: "Supermarket", delivery: "2h", image: "https://placehold.co/100x100/AEC6CF/000000?text=MDH+Biryani" }
                        ]
                    },
                    {
                        id: "ginger_garlic_paste",
                        name: "Ginger Garlic Paste",
                        description: "Freshly ground paste",
                        image: "https://placehold.co/100x100/AEC6CF/000000?text=Ginger+Garlic",
                        quantityPerServing: 0.1, // 0.1kg per 4 plates
                        brands: [
                            { id: "ggp1", name: "Patanjali Ginger Garlic Paste", weight: "200g", price: 50, marketPrice: 65, rating: 4.3, reviews: 90, store: "Local Store", delivery: "30m", image: "https://placehold.co/100x100/AEC6CF/000000?text=GGP" }
                        ]
                    },
                    {
                        id: "curd",
                        name: "Curd",
                        description: "Fresh plain curd",
                        image: "https://placehold.co/100x100/AEC6CF/000000?text=Curd",
                        quantityPerServing: 0.2, // 0.2kg per 4 plates
                        brands: [
                            { id: "curd1", name: "Amul Dahi", weight: "400g", price: 40, marketPrice: 50, rating: 4.5, reviews: 110, store: "Dairy Shop", delivery: "1h", image: "https://placehold.co/100x100/AEC6CF/000000?text=Amul+Dahi" }
                        ]
                    }
                ]
            }
        };

        // App State
        const appState = {
            currentUser: null,
            currentRecipe: null,
            currentIngredient: null,
            cart: [],
            deliveryAddress: null,
            locationEnabled: false,
            orders: [], // To store fetched orders for admin view
            showLocationPopup: false, // Control visibility of location popup
            showCheckoutModal: false, // Control visibility of checkout modal
            lastOrderId: null, // Store the last placed order ID
        };

        // DOM Elements (get them once the DOM is loaded)
        let authModal, loginTab, signupTab, loginForm, signupForm, loginBtn, signupBtn, closeAuthModal,
            authBtn, profileBtn, useGps, manualAddressSection, locationPopup, enableLocationBtn,
            skipLocationBtn, closeLocationPopup, recipeSearch, recipeResults, emptyState,
            ingredientsGrid, recipeNameElem, backToSearch, makeAgainSection, userGreeting,
            userNameElem, popularRecipes, exploreRecipesBtn, productModal, modalProductName,
            productVariants, closeProductModal, cartBtn, cartSidebar, closeCartSidebar,
            cartItems, emptyCart, cartItemsList, cartSummary, cartSubtotal, cartDelivery,
            cartSavings, cartTotal, checkoutBtn, backToCartSearch, cartCount, checkoutModal,
            closeCheckoutModal, viewOrderBtn, deliveryTime, orderIdElem, deliveryAddressElem,
            quickSearchButtons, profitPerPlateElem, totalProfitElem, navHomeBtn, navDiscoverBtn,
            navAlertsBtn, navProfileBtn, navAdminBtn, adminDashboard, adminOrdersList,
            generateAIButton, aiResultDiv;

        // Function to show custom modal
        // Made globally accessible
        window.showCustomModal = function(message, type = 'info') {
            const modal = document.getElementById('customModal');
            const modalContent = document.getElementById('customModalContent');
            const modalMessageElem = document.getElementById('customModalMessage');
            const modalCloseBtn = document.getElementById('customModalCloseBtn');

            if (!modal || !modalContent || !modalMessageElem || !modalCloseBtn) {
                console.error("Custom modal elements not found!");
                return;
            }

            modalMessageElem.textContent = message;
            modalContent.className = `bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center border-2 ${
                type === 'success' ? 'border-green-500' : type === 'error' ? 'border-red-500' : 'border-blue-500'
            }`;
            modalMessageElem.className = `text-lg font-semibold mb-4 ${
                type === 'success' ? 'text-green-700' : type === 'error' ? 'text-red-700' : 'text-blue-700'
            }`;
            modalCloseBtn.className = `px-4 py-2 rounded-md font-semibold text-white transition duration-200 ${
                type === 'success' ? 'bg-green-600 hover:bg-green-700' : type === 'error' ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700'
            }`;

            modal.classList.remove('hidden');
        }

        // Function to close custom modal
        // Made globally accessible
        window.closeCustomModal = function() {
            const modal = document.getElementById('customModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        // Function to get DOM elements after they are rendered
        function getDOMElements() {
            authModal = document.getElementById('authModal');
            loginTab = document.getElementById('loginTab');
            signupTab = document.getElementById('signupTab');
            loginForm = document.getElementById('loginForm');
            signupForm = document.getElementById('signupForm');
            loginBtn = document.getElementById('loginBtn');
            signupBtn = document.getElementById('signupBtn');
            closeAuthModal = document.getElementById('closeAuthModal');
            authBtn = document.getElementById('authBtn');
            profileBtn = document.getElementById('profileBtn');
            useGps = document.getElementById('useGps');
            manualAddressSection = document.getElementById('manualAddressSection');
            locationPopup = document.getElementById('locationPopup');
            enableLocationBtn = document.getElementById('enableLocationBtn');
            skipLocationBtn = document.getElementById('skipLocationBtn');
            closeLocationPopup = document.getElementById('closeLocationPopup');
            recipeSearch = document.getElementById('recipeSearch');
            recipeResults = document.getElementById('recipeResults');
            emptyState = document.getElementById('emptyState');
            ingredientsGrid = document.getElementById('ingredientsGrid');
            recipeNameElem = document.getElementById('recipeName');
            backToSearch = document.getElementById('backToSearchBtn');
            makeAgainSection = document.getElementById('makeAgainSection');
            userGreeting = document.getElementById('userGreeting');
            userNameElem = document.getElementById('userName');
            popularRecipes = document.getElementById('popularRecipes');
            exploreRecipesBtn = document.getElementById('exploreRecipesBtn');
            productModal = document.getElementById('productModal');
            modalProductName = document.getElementById('modalProductName');
            productVariants = document.getElementById('productVariants');
            closeProductModal = document.getElementById('closeProductModal');
            cartBtn = document.getElementById('cartBtn');
            cartSidebar = document.getElementById('cartSidebar');
            closeCartSidebar = document.getElementById('closeCartSidebar');
            cartItems = document.getElementById('cartItems');
            emptyCart = document.getElementById('emptyCart');
            cartItemsList = document.getElementById('cartItemsList');
            cartSummary = document.getElementById('cartSummary');
            cartSubtotal = document.getElementById('cartSubtotal');
            cartDelivery = document.getElementById('cartDelivery');
            cartSavings = document.getElementById('cartSavings');
            cartTotal = document.getElementById('cartTotal');
            checkoutBtn = document.getElementById('checkoutBtn');
            backToCartSearch = document.getElementById('backToCartSearch');
            cartCount = document.getElementById('cartCount');
            checkoutModal = document.getElementById('checkoutModal');
            closeCheckoutModal = document.getElementById('closeCheckoutModal');
            viewOrderBtn = document.getElementById('viewOrderBtn');
            deliveryTime = document.getElementById('deliveryTime');
            orderIdElem = document.getElementById('orderId');
            deliveryAddressElem = document.getElementById('deliveryAddress');
            quickSearchButtons = document.querySelectorAll('.recipeQuickSearch');
            profitPerPlateElem = document.getElementById('profitPerPlate');
            totalProfitElem = document.getElementById('totalProfit');
            navHomeBtn = document.getElementById('navHomeBtn');
            navDiscoverBtn = document.getElementById('navDiscoverBtn');
            navAlertsBtn = document.getElementById('navAlertsBtn');
            navProfileBtn = document.getElementById('navProfileBtn');
            navAdminBtn = document.getElementById('navAdminBtn');
            adminDashboard = document.getElementById('adminDashboard');
            adminOrdersList = document.getElementById('adminOrdersList');
            generateAIButton = document.getElementById('generateAI'); // New AI button
            aiResultDiv = document.getElementById('aiResult'); // New AI result div
        }

        // Helper Functions
        function formatCurrency(amount) {
            return '₹' + amount.toFixed(2);
        }

        function calculateSavings(cart) {
            return cart.reduce((total, item) => {
                return total + (item.marketPrice - item.price) * item.quantity;
            }, 0);
        }

        function calculateCartSummary() {
            let totalCost = 0;
            let totalSavings = 0;
            appState.cart.forEach(item => {
                totalCost += item.price * item.quantity;
                totalSavings += (item.marketPrice - item.price) * item.quantity;
            });
            return { totalCost, totalSavings };
        }

        function updateCartCount() {
            const count = appState.cart.reduce((total, item) => total + item.quantity, 0);
            if (cartCount) cartCount.textContent = count;
            if (count > 0) {
                if (cartCount) cartCount.classList.remove('hidden');
                if (emptyCart) emptyCart.classList.add('hidden');
                if (cartItemsList) cartItemsList.classList.remove('hidden');
                if (cartSummary) cartSummary.classList.remove('hidden');
                if (checkoutBtn) {
                    checkoutBtn.disabled = false;
                    checkoutBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            } else {
                if (cartCount) cartCount.classList.add('hidden');
                if (emptyCart) emptyCart.classList.remove('hidden');
                if (cartItemsList) cartItemsList.classList.add('hidden');
                if (cartSummary) cartSummary.classList.add('hidden');
                if (checkoutBtn) {
                    checkoutBtn.disabled = true;
                    checkoutBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            }
        }

        function updateIngredientsForServings(servingCount) {
            if (!appState.currentRecipe) return;

            const multiplier = servingCount / appState.currentRecipe.baseServings;
            const totalProfit = servingCount * appState.currentRecipe.profitPerPlate;

            // Update profit display
            if (profitPerPlateElem) profitPerPlateElem.textContent = formatCurrency(appState.currentRecipe.profitPerPlate);
            if (totalProfitElem) totalProfitElem.textContent = formatCurrency(totalProfit);

            // Update quantities for all items in cart according to new serving size
            appState.cart.forEach(item => {
                const originalIngredient = recipesDatabase[appState.currentRecipe.name.toLowerCase()]
                    .ingredients.find(ing => ing.id === item.id);
                if (originalIngredient && originalIngredient.quantityPerServing) {
                    item.quantity = Math.ceil(originalIngredient.quantityPerServing * multiplier);
                }
            });
            renderCartItems();
        }

        function renderCartItems() {
            if (!cartItemsList) return;
            cartItemsList.innerHTML = '';

            let subtotal = 0;
            let savings = 0;

            appState.cart.forEach(item => {
                subtotal += item.price * item.quantity;
                savings += (item.marketPrice - item.price) * item.quantity;

                const cartItem = document.createElement('div');
                cartItem.className = 'flex justify-between items-start py-3 border-b';
                cartItem.innerHTML = `
                    <div class="flex">
                        <div class="w-16 h-16 rounded-lg bg-gray-100 overflow-hidden mr-3">
                            <img src="${item.image}" alt="${item.name}" class="w-full h-full object-cover">
                        </div>
                        <div>
                            <h3 class="font-medium text-gray-800">${item.name}</h3>
                            <p class="text-sm text-gray-500">${item.weight} • ${item.store}</p>
                            <div class="flex items-center mt-1">
                                <span class="text-green-600 font-medium mr-2">${formatCurrency(item.price)}</span>
                                <span class="text-xs text-gray-400 line-through">${formatCurrency(item.marketPrice)}</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <button class="decreaseQuantity text-gray-400 hover:text-green-500 p-1" data-id="${item.id}">
                            <i class="fas fa-minus text-sm"></i>
                        </button>
                        <span class="quantity mx-2 w-6 text-center">${item.quantity}</span>
                        <button class="increaseQuantity text-gray-400 hover:text-green-500 p-1" data-id="${item.id}">
                            <i class="fas fa-plus text-sm"></i>
                        </button>
                    </div>
                `;
                cartItemsList.appendChild(cartItem);
            });

            if (cartSubtotal) cartSubtotal.textContent = formatCurrency(subtotal);
            if (cartSavings) cartSavings.textContent = formatCurrency(savings);
            if (cartTotal) cartTotal.textContent = formatCurrency(subtotal + 40); // Adding delivery fee

            // Add event listeners to quantity buttons
            document.querySelectorAll('.increaseQuantity').forEach(button => {
                button.onclick = (e) => { // Use onclick for dynamically added elements
                    const id = e.target.closest('button').dataset.id;
                    const item = appState.cart.find(item => item.id === id);
                    if (item) {
                        item.quantity += 1;
                        renderCartItems();
                        updateCartCount();
                    }
                };
            });

            document.querySelectorAll('.decreaseQuantity').forEach(button => {
                button.onclick = (e) => { // Use onclick for dynamically added elements
                    const id = e.target.closest('button').dataset.id;
                    const itemIndex = appState.cart.findIndex(item => item.id === id);
                    if (itemIndex !== -1) {
                        if (appState.cart[itemIndex].quantity > 1) {
                            appState.cart[itemIndex].quantity -= 1;
                        } else {
                            appState.cart.splice(itemIndex, 1); // Remove item if quantity is 1
                        }
                        renderCartItems();
                        updateCartCount();
                    }
                };
            });
        }

        // Main render function to update the DOM based on current state
        function renderApp() {
            const appRoot = document.getElementById('app-root');
            if (!appRoot) {
                console.error("App root element not found!");
                return;
            }

            let pageContent = '';

            // Render Header
            let headerContent = `
                <header class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-40">
                    <div class="flex items-center space-x-2">
                        <img src="https://placehold.co/40x40/6366F1/FFFFFF?text=S" alt="Sangraha Logo" class="rounded-full" />
                        <h1 class="text-2xl font-bold text-indigo-700">Sangraha</h1>
                    </div>
                    <nav class="flex items-center space-x-4">
                        ${appState.currentUser ? `
                            <button id="logoutBtn" class="flex items-center space-x-1 text-red-500 hover:text-red-700 transition duration-200">
                                <i class="fas fa-sign-out-alt text-xl"></i> <span class="hidden sm:inline">Logout</span>
                            </button>
                        ` : `
                            <button id="loginSignupBtn" class="flex items-center space-x-1 text-indigo-600 hover:text-indigo-800 transition duration-200">
                                <i class="fas fa-user-circle text-xl"></i> <span class="hidden sm:inline">Login/Signup</span>
                            </button>
                        `}
                        <button id="cartNavBtn" class="flex items-center space-x-1 text-gray-600 hover:text-indigo-700 transition duration-200 relative">
                            <i class="fas fa-shopping-cart text-xl"></i> <span class="hidden sm:inline">Cart</span>
                            <span id="cartCount" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center ${appState.cart.length > 0 ? '' : 'hidden'}">
                                ${appState.cart.length}
                            </span>
                        </button>
                    </nav>
                </header>
            `;

            // Render Modals (always present in DOM, hidden/shown by JS)
            let modalsContent = `
                <!-- Authentication Modal -->
                <div id="authModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4 ${appState.currentUser ? 'hidden' : ''}">
                    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden slide-up">
                        <div class="flex items-center justify-between p-6 border-b">
                            <div class="flex-1">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center mr-3">
                                        <i class="fas fa-leaf text-green-500"></i>
                                    </div>
                                    <h2 class="text-xl font-bold text-gray-800">Welcome to Sangraha</h2>
                                </div>
                                <p class="text-sm text-gray-500 mt-2">Access the smartest way to cook healthy meals</p>
                            </div>
                            <button id="closeAuthModal" class="text-gray-400 hover:text-gray-500">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        <div class="flex border-b">
                            <button id="loginTab" class="flex-1 py-4 font-medium text-center ${currentPage === 'login' ? 'border-b-4 border-green-500 text-green-600' : 'text-gray-500'}">Login</button>
                            <button id="signupTab" class="flex-1 py-4 font-medium text-center ${currentPage === 'register' ? 'border-b-4 border-green-500 text-green-600' : 'text-gray-500'}">Sign Up</button>
                        </div>

                        <div id="loginForm" class="p-6 ${currentPage === 'login' ? '' : 'hidden'}">
                            <div class="mb-4">
                                <input type="email" id="loginEmail" placeholder="Email address" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-200 focus:border-green-500">
                            </div>
                            <div class="mb-4">
                                <input type="password" id="loginPassword" placeholder="Password" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-200 focus:border-green-500">
                            </div>
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center">
                                    <input type="checkbox" id="rememberMe" class="h-4 w-4 text-green-500 focus:ring-green-500 border-gray-300 rounded">
                                    <label for="rememberMe" class="ml-2 text-sm text-gray-700">Remember me</label>
                                </div>
                                <a href="#" class="text-sm text-green-500 hover:underline">Forgot password?</a>
                            </div>
                            <button id="loginBtn" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-medium transition flex items-center justify-center">
                                <i class="fas fa-sign-in-alt mr-2"></i>
                                Log In
                            </button>
                            <p class="text-center mt-4 text-gray-600">
                                Don't have an account? <button id="switchToSignupBtn" class="text-green-500 hover:underline">Sign up</button>
                            </p>
                        </div>

                        <div id="signupForm" class="p-6 ${currentPage === 'register' ? '' : 'hidden'}">
                            <div class="mb-4">
                                <input type="text" id="signupName" placeholder="Full name" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-200 focus:border-green-500">
                            </div>
                            <div class="mb-4">
                                <input type="email" id="signupEmail" placeholder="Email address" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-200 focus:border-green-500">
                            </div>
                            <div class="mb-4">
                                <input type="password" id="signupPassword" placeholder="Create password" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-200 focus:border-green-500">
                            </div>
                            <div class="mb-4">
                                <div class="flex items-center">
                                    <input type="checkbox" id="useGps" class="h-4 w-4 text-green-500 focus:ring-green-500 border-gray-300 rounded">
                                    <label for="useGps" class="ml-2 text-gray-700">Use my current location for delivery</label>
                                </div>
                                <div id="manualAddressSection" class="mt-3 ${appState.locationEnabled ? 'hidden' : ''}">
                                    <textarea id="deliveryAddressInput" placeholder="Enter delivery address" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-green-200 focus:border-green-500">${appState.deliveryAddress || ''}</textarea>
                                </div>
                            </div>
                            <button id="signupBtn" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-medium transition">
                                Create Account
                            </button>
                            <p class="text-xs text-gray-500 mt-4">
                                By signing up, you agree to our <a href="#" class="text-green-500">Terms of Service</a> and <a href="#" class="text-green-500">Privacy Policy</a>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Location Popup -->
                <div id="locationPopup" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4 ${appState.showLocationPopup ? '' : 'hidden'}">
                    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden slide-up p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-gray-800">Enable Location Access</h3>
                            <button id="closeLocationPopup" class="text-gray-400 hover:text-gray-500">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <p class="text-gray-600 mb-6">We need your location to find nearby suppliers and accurate delivery estimates. Your location data is never shared with others.</p>
                        <div class="flex space-x-3">
                            <button id="enableLocationBtn" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg font-medium transition">
                                Allow Location
                            </button>
                            <button id="skipLocationBtn" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 rounded-lg font-medium transition">
                                Enter Manually
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Product Selection Modal -->
                <div id="productModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4 ${appState.currentIngredient ? '' : 'hidden'}">
                    <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto slide-up">
                        <div class="sticky top-0 bg-white p-6 border-b flex justify-between items-center">
                            <div>
                                <h2 class="text-xl font-bold text-gray-800"><span id="modalProductName">${appState.currentIngredient ? appState.currentIngredient.name : ''}</span> Variants</h2>
                                <p class="text-sm text-gray-500">Choose from different brands</p>
                            </div>
                            <button id="closeProductModal" class="text-gray-400 hover:text-gray-500">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        <div id="productVariants" class="p-6 space-y-4">
                            ${appState.currentIngredient && appState.currentIngredient.brands ? appState.currentIngredient.brands.map(brand => `
                                <div class="product-card bg-gray-50 rounded-xl p-4 shadow-sm flex items-center justify-between transition transform hover:scale-[1.02]">
                                    <div class="flex items-center">
                                        <img src="${brand.image}" alt="${brand.name}" class="w-16 h-16 rounded-lg object-cover mr-4 border border-gray-200">
                                        <div>
                                            <h3 class="font-semibold text-gray-800">${brand.name}</h3>
                                            <p class="text-sm text-gray-500">${brand.weight} • ${brand.store} (${brand.delivery} delivery)</p>
                                            <div class="flex items-center mt-1">
                                                <span class="text-green-600 font-bold mr-2">${formatCurrency(brand.price)}</span>
                                                <span class="text-xs text-gray-400 line-through">${formatCurrency(brand.marketPrice)}</span>
                                                <span class="ml-2 text-xs text-yellow-600"><i class="fas fa-star"></i> ${brand.rating} (${brand.reviews})</span>
                                            </div>
                                        </div>
                                    </div>
                                    <button class="addToCartBtn bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition" data-ingredient-id="${appState.currentIngredient.id}" data-brand-id="${brand.id}">
                                        Add to Cart
                                    </button>
                                </div>
                            `).join('') : '<p class="text-center text-gray-600">No variants available.</p>'}
                        </div>
                    </div>
                </div>

                <!-- Cart Sidebar -->
                <div id="cartSidebar" class="fixed inset-y-0 right-0 z-40 w-full sm:w-96 bg-white shadow-lg transform translate-x-full transition-transform duration-300 ease-in-out">
                    <div class="flex flex-col h-full">
                        <div class="flex justify-between items-center p-6 border-b">
                            <h2 class="text-xl font-bold text-gray-800">Your Cart</h2>
                            <button id="closeCartSidebar" class="text-gray-400 hover:text-gray-500">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        <div id="cartItems" class="flex-1 overflow-y-auto p-6">
                            <div id="emptyCart" class="flex flex-col items-center justify-center h-full text-center ${appState.cart.length > 0 ? 'hidden' : ''}">
                                <div class="mx-auto w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                                    <i class="fas fa-shopping-basket text-3xl text-gray-400"></i>
                                </div>
                                <h3 class="text-lg font-medium text-gray-800 mb-2">Your cart is empty</h3>
                                <p class="text-gray-500 mb-4">Add ingredients from your recipe to get started</p>
                                <button id="backToRecipeBtn" class="text-green-500 hover:text-green-700 font-medium flex items-center">
                                    <i class="fas fa-arrow-left mr-2"></i>
                                    Back to recipe
                                </button>
                            </div>

                            <div id="cartItemsList" class="space-y-4 ${appState.cart.length > 0 ? '' : 'hidden'}"></div>
                        </div>

                        <div id="cartSummary" class="p-6 border-t ${appState.cart.length > 0 ? '' : 'hidden'}">
                            <div class="space-y-3 mb-4">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Subtotal</span>
                                    <span id="cartSubtotal" class="font-medium">${formatCurrency(appState.cart.reduce((sum, item) => sum + item.price * item.quantity, 0))}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Delivery</span>
                                    <span id="cartDelivery" class="font-medium">₹40.00</span>
                                </div>
                                <div class="flex justify-between text-green-600">
                                    <span>You save</span>
                                    <span id="cartSavings">${formatCurrency(calculateSavings(appState.cart))}</span>
                                </div>
                            </div>
                            <div class="flex justify-between text-lg font-bold mb-6">
                                <span>Total</span>
                                <span id="cartTotal">${formatCurrency(appState.cart.reduce((sum, item) => sum + item.price * item.quantity, 0) + 40)}</span>
                            </div>
                            <div class="bg-yellow-50 rounded-lg p-3 mb-4">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Potential profit per plate</span>
                                    <span id="profitPerPlate">${appState.currentRecipe ? formatCurrency(appState.currentRecipe.profitPerPlate) : formatCurrency(0)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Total potential profit</span>
                                    <span id="totalProfit">${appState.currentRecipe ? formatCurrency(appState.currentRecipe.profitPerPlate * appState.currentRecipe.baseServings) : formatCurrency(0)}</span>
                                </div>
                            </div>
                            <button id="checkoutBtn" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-medium transition flex items-center justify-center ${appState.cart.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${appState.cart.length === 0 ? 'disabled' : ''}>
                                <i class="fas fa-lock mr-2"></i>
                                Proceed to Checkout
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Checkout Modal -->
                <div id="checkoutModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4 ${appState.showCheckoutModal ? '' : 'hidden'}">
                    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden slide-up">
                        <div class="p-6 border-b flex justify-between items-center">
                            <div>
                                <h2 class="text-xl font-bold text-gray-800">Order Confirmation</h2>
                                <p class="text-sm text-gray-500">Your delivery is on the way</p>
                            </div>
                            <button id="closeCheckoutModal" class="text-gray-400 hover:text-gray-500">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        <div class="p-6">
                            <div class="flex items-center justify-center mb-6">
                                <div class="w-20 h-20 rounded-full bg-green-100 flex items-center justify-center text-green-500">
                                    <i class="fas fa-check text-3xl"></i>
                                </div>
                            </div>
                            <h3 class="text-center text-lg font-bold text-gray-800 mb-2">Order Placed Successfully!</h3>
                            <p class="text-center text-gray-600 mb-6">Your ingredients will be delivered by <span id="deliveryTime" class="font-medium">tomorrow 6 PM</span></p>

                            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                                <div class="flex justify-between mb-2">
                                    <span class="text-gray-600">Order ID</span>
                                    <span id="orderId" class="font-mono">${appState.lastOrderId || 'N/A'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Delivery to</span>
                                    <span id="deliveryAddress" class="text-right font-medium">${appState.currentUser ? appState.currentUser.address : 'N/A'}</span>
                                </div>
                            </div>

                            <button id="viewOrderDetailsBtn" class="w-full bg-green-100 hover:bg-green-200 text-green-700 py-2 rounded-lg font-medium transition">
                                View Order Details
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Main Page Content
            let mainContent = '';
            if (!appState.currentUser) {
                // Initial state, show hero section and prompt for login/signup
                mainContent = `
                    <section class="hero-gradient rounded-2xl p-8 text-white mb-8">
                        <div class="max-w-xl">
                            <h1 class="text-3xl md:text-4xl font-bold mb-4">Smart shopping for smarter cooking</h1>
                            <p class="mb-6">Get all ingredients for your favorite recipes at the best prices.</p>
                            <div class="relative">
                                
                            <input
  id="recipeSearch"
  type="text"
  value=""
  autocomplete="off"
  name="not-email-or-username"
  inputmode="search"
  autocapitalize="off"
  spellcheck="false"
  placeholder="Type what do you need to prepare?"
  class="w-full px-6 py-4 rounded-full bg-white bg-opacity-20 placeholder-white placeholder-opacity-80 text-white focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50"
/>
                                <button id="searchRecipeBtn" class="absolute right-2 top-2 bg-white text-green-500 p-3 rounded-full hover:bg-gray-100 transition">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <p class="text-xs text-white text-opacity-70 mt-3">Try "Panipuri", "Biryani", etc.</p>
                        </div>
                    </section>
                    <section id="popularRecipes" class="mb-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Popular Recipes</h2>
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                            <button id="quickSearchPanipuri" class="recipeQuickSearch bg-white rounded-xl p-4 shadow-sm hover:shadow-md transition cursor-pointer text-center">
                                <div class="w-16 h-16 mx-auto mb-2 rounded-full bg-green-100 flex items-center justify-center">
                                    <img src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/031b6a91-2d3a-437a-8a6c-9cba3a1fbc19.png" alt="Panipuri Snack" class="w-full h-full rounded-full object-cover">
                                </div>
                                <span class="text-sm font-medium text-gray-800">Panipuri</span>
                            </button>
                            <button id="quickSearchBiryani" class="recipeQuickSearch bg-white rounded-xl p-4 shadow-sm hover:shadow-md transition cursor-pointer text-center">
                                <div class="w-16 h-16 mx-auto mb-2 rounded-full bg-yellow-100 flex items-center justify-center">
                                    <img src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/29705d98-f809-408a-9859-539f967e5acb.png" alt="Chicken Biryani" class="w-full h-full rounded-full object-cover">
                                </div>
                                <span class="text-sm font-medium text-gray-800">Biryani</span>
                            </button>
                            <button id="quickSearchPasta" class="recipeQuickSearch bg-white rounded-xl p-4 shadow-sm hover:shadow-md transition cursor-pointer text-center">
                                <div class="w-16 h-16 mx-auto mb-2 rounded-full bg-blue-100 flex items-center justify-center">
                                    <img src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/fd9ae761-b041-4ade-8051-f03ae6508684.png" alt="Vegetable Pasta" class="w-full h-full rounded-full object-cover">
                                </div>
                                <span class="text-sm font-medium text-gray-800">Pasta</span>
                            </button>
                            <button id="quickSearchDessert" class="recipeQuickSearch bg-white rounded-xl p-4 shadow-sm hover:shadow-md transition cursor-pointer text-center">
                                <div class="w-16 h-16 mx-auto mb-2 rounded-full bg-red-100 flex items-center justify-center">
                                    <img src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/188333ab-ea5f-484e-8da9-7e5b82a3e660.png" alt="Chocolate Dessert" class="w-full h-full rounded-full object-cover">
                                </div>
                                <span class="text-sm font-medium text-gray-800">Dessert</span>
                            </button>
                        </div>
                    </section>
                `;
            } else {
                // Logged in user content
                if (currentPage === 'home') {
                    mainContent = `
                        <div id="userGreeting" class="mb-8">
                            <h2 class="text-2xl font-bold text-gray-800">Welcome back, <span id="userName" class="text-green-500">${appState.currentUser.name}</span></h2>
                            <p class="text-gray-600">What would you like to cook today?</p>
                        </div>
                        <section class="hero-gradient rounded-2xl p-8 text-white mb-8">
                            <div class="max-w-xl">
                                <h1 class="text-3xl md:text-4xl font-bold mb-4">Smart shopping for smarter cooking</h1>
                                <p class="mb-6">Get all ingredients for your favorite recipes at the best prices.</p>
                                <div class="relative">
                                <input
  id="recipeSearch"
  type="text"
  value=""
  autocomplete="off"
  name="not-email-or-username"
  inputmode="search"
  autocapitalize="off"
  spellcheck="false"
  placeholder="Type what do you need to prepare?"
  class="w-full px-6 py-4 rounded-full bg-white bg-opacity-20 placeholder-white placeholder-opacity-80 text-white focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50"
/>

                                    <button id="searchRecipeBtn" class="absolute right-2 top-2 bg-white text-green-500 p-3 rounded-full hover:bg-gray-100 transition">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                                <p class="text-xs text-white text-opacity-70 mt-3">Try "Panipuri", "Biryani", etc.</p>
                            </div>
                        </section>
                        <section id="makeAgainSection" class="mt-8">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">Make Again</h2>
                            <div class="bg-white rounded-xl p-4 shadow-sm">
                                <div class="flex items-center mb-4">
                                    <div class="w-16 h-16 rounded-lg bg-green-50 flex items-center justify-center mr-4">
                                        <img src="https://tse4.mm.bing.net/th/id/OIP.tE3Q7pwFMJnrt9boDv0lNgHaE8?pid=Api&P=0&h=180">
                                    </div>
                                    <div>
                                        <h3 class="font-medium text-gray-800">Panipuri Kit</h3>
                                        <p class="text-sm text-gray-500">You ordered this last week</p>
                                    </div>
                                </div>
                                <button id="makeAgainPanipuri" class="w-full bg-green-100 hover:bg-green-200 text-green-700 py-2 rounded-lg font-medium transition">
                                    Prepare Again
                                </button>
                            </div>
                        </section>
                        <section id="popularRecipes" class="mt-8">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">Popular Recipes</h2>
                            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                                <button id="quickSearchPanipuri2" class="recipeQuickSearch bg-white rounded-xl p-4 shadow-sm hover:shadow-md transition cursor-pointer text-center">
                                    <div class="w-16 h-16 mx-auto mb-2 rounded-full bg-green-100 flex items-center justify-center">
                                        <img src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/031b6a91-2d3a-437a-8a6c-9cba3a1fbc19.png" alt="Panipuri Snack" class="w-full h-full rounded-full object-cover">
                                    </div>
                                    <span class="text-sm font-medium text-gray-800">Panipuri</span>
                                </button>
                                <button id="quickSearchBiryani2" class="recipeQuickSearch bg-white rounded-xl p-4 shadow-sm hover:shadow-md transition cursor-pointer text-center">
                                    <div class="w-16 h-16 mx-auto mb-2 rounded-full bg-yellow-100 flex items-center justify-center">
                                        <img src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/29705d98-f809-408a-9859-539f967e5acb.png" alt="Chicken Biryani" class="w-full h-full rounded-full object-cover">
                                    </div>
                                    <span class="text-sm font-medium text-gray-800">Biryani</span>
                                </button>
                                <button id="quickSearchPasta2" class="recipeQuickSearch bg-white rounded-xl p-4 shadow-sm hover:shadow-md transition cursor-pointer text-center">
                                    <div class="w-16 h-16 mx-auto mb-2 rounded-full bg-blue-100 flex items-center justify-center">
                                        <img src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/fd9ae761-b041-4ade-8051-f03ae6508684.png" alt="Vegetable Pasta" class="w-full h-full rounded-full object-cover">
                                    </div>
                                    <span class="text-sm font-medium text-gray-800">Pasta</span>
                                </button>
                                <button id="quickSearchDessert2" class="recipeQuickSearch bg-white rounded-xl p-4 shadow-sm hover:shadow-md transition cursor-pointer text-center">
                                    <div class="w-16 h-16 mx-auto mb-2 rounded-full bg-red-100 flex items-center justify-center">
                                        <img src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/188333ab-ea5f-484e-8da9-7e5b82a3e660.png" alt="Chocolate Dessert" class="w-full h-full rounded-full object-cover">
                                </div>
                                <span class="text-sm font-medium text-gray-800">Dessert</span>
                            </button>
                        </div>
                    </section>
                `;
            } else if (currentPage === 'ingredients' && appState.currentRecipe) {
                mainContent = `
                    <section id="recipeResults">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Planning to prepare <span id="recipeName" class="text-green-500">${appState.currentRecipe.name}</span></h2>

                        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                            <h3 class="text-lg font-medium text-blue-800 flex items-center mb-2">
                                <i class="fas fa-user-group text-blue-600 mr-2"></i>
                                How many plates are you preparing today?
                            </h3>
                            <div class="flex flex-wrap gap-3">
                                <button id="servings10" class="serving-btn bg-white border border-blue-300 rounded-lg px-4 py-2 font-medium focus:bg-blue-100 focus:border-blue-500 hover:bg-blue-50" data-servings="10">10</button>
                                <button id="servings25" class="serving-btn bg-white border border-blue-300 rounded-lg px-4 py-2 font-medium focus:bg-blue-100 focus:border-blue-500 hover:bg-blue-50" data-servings="25">25</button>
                                <button id="servings50" class="serving-btn bg-white border border-blue-300 rounded-lg px-4 py-2 font-medium focus:bg-blue-100 focus:border-blue-500 hover:bg-blue-50" data-servings="50">50</button>
                                <button id="servings100" class="serving-btn bg-white border border-blue-300 rounded-lg px-4 py-2 font-medium focus:bg-blue-100 focus:border-blue-500 hover:bg-blue-50" data-servings="100">100</button>
                                <button id="servings500" class="serving-btn bg-white border border-blue-300 rounded-lg px-4 py-2 font-medium focus:bg-blue-100 focus:border-blue-500 hover:bg-blue-50" data-servings="500">500</button>
                                <button id="servings1000" class="serving-btn bg-white border border-blue-300 rounded-lg px-4 py-2 font-medium focus:bg-blue-100 focus:border-blue-500 hover:bg-blue-50" data-servings="1000">1000</button>
                            </div>
                            <div class="mt-3">
                                <label class="text-sm text-gray-600">Or specify exact number:</label>
                                <input type="number" id="customServings" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-200 focus:border-blue-500" placeholder="Enter plate count">
                            </div>
                        </div>

                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold text-gray-800">Ingredients Needed</h2>
                            <button id="backToSearchBtn" class="text-green-500 hover:text-green-700 font-medium flex items-center">
                                <i class="fas fa-arrow-left mr-2"></i>
                                Search again
                            </button>
                        </div>

                        <div id="ingredientsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${appState.currentRecipe.ingredients.map(ingredient => `
                                <div class="ingredient-card bg-white rounded-xl p-4 shadow-sm hover:shadow-md transition cursor-pointer text-center" data-ingredient-id="${ingredient.id}">
                                    <div class="w-24 h-24 mx-auto mb-2 rounded-full bg-gray-100 flex items-center justify-center overflow-hidden">
                                        <img src="${ingredient.image}" alt="${ingredient.name}" class="w-full h-full object-cover">
                                    </div>
                                    <h3 class="font-medium text-gray-800">${ingredient.name}</h3>
                                    <p class="text-sm text-gray-500">${ingredient.description}</p>
                                </div>
                            `).join('')}
                        </div>
                    </section>
                `;
            } else if (currentPage === 'cart') {
                mainContent = `
                    <div class="max-w-3xl mx-auto bg-white p-8 rounded-xl shadow-lg mt-10">
                        <h2 class="text-3xl font-bold text-indigo-700 mb-6 text-center">Your Cart</h2>
                        ${appState.cart.length === 0 ? `
                            <p class="text-center text-gray-600 text-lg">Your cart is empty. Start by finding a recipe kit!</p>
                        ` : `
                            <div class="space-y-4 mb-8">
                                <div id="cartItemsList" class="space-y-4"></div>
                            </div>

                            <div class="bg-indigo-50 p-6 rounded-lg shadow-inner mb-8">
                                <h3 class="text-2xl font-bold text-indigo-700 mb-4">Order Summary</h3>
                                <div class="space-y-3 mb-4">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Subtotal</span>
                                        <span id="cartSubtotal" class="font-medium">${formatCurrency(appState.cart.reduce((sum, item) => sum + item.price * item.quantity, 0))}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Delivery</span>
                                        <span id="cartDelivery" class="font-medium">₹40.00</span>
                                    </div>
                                    <div class="flex justify-between text-green-600">
                                        <span>You save</span>
                                        <span id="cartSavings">${formatCurrency(calculateSavings(appState.cart))}</span>
                                    </div>
                                </div>
                                <div class="flex justify-between text-lg font-bold mb-6">
                                    <span>Total</span>
                                    <span id="cartTotal">${formatCurrency(appState.cart.reduce((sum, item) => sum + item.price * item.quantity, 0) + 40)}</span>
                                </div>
                                <div class="bg-yellow-50 rounded-lg p-3 mb-4">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Potential profit per plate</span>
                                        <span id="profitPerPlate">${appState.currentRecipe ? formatCurrency(appState.currentRecipe.profitPerPlate) : formatCurrency(0)}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Total potential profit</span>
                                        <span id="totalProfit">${appState.currentRecipe ? formatCurrency(appState.currentRecipe.profitPerPlate * appState.currentRecipe.baseServings) : formatCurrency(0)}</span>
                                    </div>
                                </div>
                                <button id="checkoutBtn" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-medium transition flex items-center justify-center ${appState.cart.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${appState.cart.length === 0 ? 'disabled' : ''}>
                                    <i class="fas fa-lock mr-2"></i>
                                    Proceed to Checkout
                                </button>
                            </div>
                        `}
                        <div class="flex justify-center mt-6">
                            <button id="continueShoppingBtn" class="text-indigo-600 hover:text-indigo-800 font-semibold flex items-center">
                                <i class="fas fa-home mr-1"></i> Continue Shopping
                            </button>
                        </div>
                    </div>
                `;
            } else if (currentPage === 'admin') {
                mainContent = `
                    <div id="adminDashboard" class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-lg mt-10">
                        <h2 class="text-3xl font-bold text-indigo-700 mb-6 text-center">Admin Dashboard - Orders</h2>
                        ${appState.orders.length === 0 ? `
                            <p class="text-center text-gray-600 text-lg">No orders received yet.</p>
                        ` : `
                            <div id="adminOrdersList" class="space-y-4">
                                ${appState.orders.map(order => `
                                    <div class="border border-gray-200 p-6 rounded-lg shadow-md bg-gray-50">
                                        <div class="flex justify-between items-center mb-3">
                                            <h3 class="text-xl font-bold text-indigo-800">Order ID: ${order.id ? order.id.substring(0, 8) + '...' : 'N/A'}</h3>
                                            <span class="px-3 py-1 rounded-full text-sm font-semibold ${order.status === 'Pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">
                                                ${order.status}
                                            </span>
                                        </div>
                                        <p class="text-gray-700 mb-1"><span class="font-semibold">User:</span> ${order.userName || 'Guest'} (${order.userEmail || 'N/A'})</p>
                                        <p class="text-gray-700 mb-1"><span class="font-semibold">User ID:</span> ${order.userId || 'N/A'}</p>
                                        <p class="text-gray-700 mb-1"><span class="font-semibold">Delivery Address:</span> ${order.deliveryAddress || 'N/A'}</p>
                                        <p class="text-gray-700 mb-1"><span class="font-semibold">Dish Requested:</span> ${order.dishName || 'N/A'}</p>
                                        <p class="text-gray-700 mb-3"><span class="font-semibold">Order Date:</span> ${order.timestamp ? new Date(order.timestamp.toDate()).toLocaleString() : 'N/A'}</p>

                                        <div class="mt-4 border-t pt-4">
                                            <h4 class="font-semibold text-indigo-700 mb-2">Items:</h4>
                                            <ul class="list-disc list-inside text-gray-700">
                                                ${order.orderedItems ? order.orderedItems.map(item => `
                                                    <li>${item.name} (${item.brand}) - ₹${item.price} x ${item.quantity} = ₹${item.price * item.quantity}</li>
                                                `).join('') : 'No items.'}
                                            </ul>
                                        </div>
                                        <div class="mt-4 flex justify-between items-center font-bold text-lg">
                                            <span class="text-gray-800">Total Order Value:</span>
                                            <span class="text-indigo-700">₹${order.totalCost ? order.totalCost.toLocaleString() : '0.00'}</span>
                                        </div>
                                        <div class="flex justify-between items-center font-bold text-md text-green-700">
                                            <span>Total Savings for User:</span>
                                            <span>₹${order.totalSavings ? order.totalSavings.toLocaleString() : '0.00'}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                `;
            }
        }

        appRoot.innerHTML = `
            <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 font-sans text-gray-800 flex flex-col">
                ${headerContent}
                <main class="flex-grow container mx-auto p-4 sm:p-6 lg:p-8">
                    ${mainContent}
                    <!-- Add a button to generate AI content -->
                    <div class="max-w-6xl mx-auto px-4 py-6">
                        <button
                            id="generateAI"
                            class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-medium transition"
                        >
                            Generate AI Content
                        </button>
                        <div
                            id="aiResult"
                            class="mt-4 p-4 bg-gray-100 rounded text-gray-800 min-h-[80px]"
                        >
                            <!-- AI response will appear here -->
                        </div>
                    </div>
                </main>
                <footer class="bg-white shadow-inner p-4 text-center text-gray-500 text-sm mt-auto">
                    &copy; ${new Date().getFullYear()} Sangraha. All rights reserved.
                </footer>
            </div>
            ${modalsContent}
        `;

        // After rendering, get new DOM element references and attach event listeners
        getDOMElements();
        attachEventListeners();
        updateCartCount(); // Update cart count on every render
        if (currentPage === 'cart' && appState.cart.length > 0) {
            renderCartItems(); // Re-render cart items if on cart page
        }
        if (currentPage === 'admin') {
            fetchOrders(); // Fetch orders if on admin page
        }
    }

    // Function to attach event listeners (called after each renderApp)
    function attachEventListeners() {
        // Re-attach listeners for elements that might be re-rendered
        if (document.getElementById('logoutBtn')) document.getElementById('logoutBtn').onclick = handleLogout;
        if (document.getElementById('loginSignupBtn')) document.getElementById('loginSignupBtn').onclick = showAuthModal;
        if (document.getElementById('cartNavBtn')) document.getElementById('cartNavBtn').onclick = () => {
            cartSidebar.style.transform = 'translateX(0)';
            renderCartItems();
        };
        if (closeAuthModal) closeAuthModal.onclick = hideAuthModal;
        if (loginTab) loginTab.onclick = showLoginForm;
        if (signupTab) signupTab.onclick = showSignupForm;
        if (loginBtn) loginBtn.onclick = handleLogin;
        if (signupBtn) signupBtn.onclick = handleSignup;
        if (useGps) useGps.onchange = toggleGpsInput;
        if (enableLocationBtn) enableLocationBtn.onclick = enableLocation;
        if (skipLocationBtn) skipLocationBtn.onclick = skipLocation;
        if (closeLocationPopup) closeLocationPopup.onclick = hideLocationPopup;
        if (recipeSearch) recipeSearch.onkeypress = (e) => {
            if (e.key === 'Enter') handleDishSearchFromInput();
        };
        if (document.getElementById('searchRecipeBtn')) document.getElementById('searchRecipeBtn').onclick = handleDishSearchFromInput;

        if (backToSearch) backToSearch.onclick = () => navigateTo('home');
        if (exploreRecipesBtn) exploreRecipesBtn.onclick = () => {
            emptyState.classList.add('hidden');
            popularRecipes.classList.remove('hidden');
        };
        if (closeCartSidebar) closeCartSidebar.onclick = closeCartSidebarFunc;
        if (checkoutBtn) checkoutBtn.onclick = handlePlaceOrder; // Directly place order
        if (closeCheckoutModal) closeCheckoutModal.onclick = closeCheckoutModalFunc;
        if (document.getElementById('viewOrderDetailsBtn')) document.getElementById('viewOrderDetailsBtn').onclick = () => { navigateTo('admin'); closeCheckoutModalFunc(); };

        // Attach listeners for navigation buttons
        if (navHomeBtn) navHomeBtn.onclick = () => navigateTo('home');
        if (navDiscoverBtn) navDiscoverBtn.onclick = () => showCustomModal('Discover feature coming soon!', 'info');
        if (navAlertsBtn) navAlertsBtn.onclick = () => showCustomModal('No new alerts.', 'info');
        if (navProfileBtn) navProfileBtn.onclick = () => showCustomModal('Profile management coming soon!', 'info');
        if (navAdminBtn) navAdminBtn.onclick = () => navigateTo('admin');

        // Re-attach quick search buttons
        if (document.getElementById('quickSearchPanipuri')) document.getElementById('quickSearchPanipuri').onclick = () => handleQuickSearch('panipuri');
        if (document.getElementById('quickSearchBiryani')) document.getElementById('quickSearchBiryani').onclick = () => handleQuickSearch('biryani');
        if (document.getElementById('quickSearchPasta')) document.getElementById('quickSearchPasta').onclick = () => showCustomModal('More recipes coming soon!', 'info');
        if (document.getElementById('quickSearchDessert')) document.getElementById('quickSearchDessert').onclick = () => showCustomModal('More recipes coming soon!', 'info');

        // For logged-in section quick search buttons (if they exist)
        if (document.getElementById('makeAgainPanipuri')) document.getElementById('makeAgainPanipuri').onclick = () => handleQuickSearch('panipuri');
        if (document.getElementById('quickSearchBiryani2')) document.getElementById('quickSearchBiryani2').onclick = () => handleQuickSearch('biryani');
        if (document.getElementById('quickSearchPasta2')) document.getElementById('quickSearchPasta2').onclick = () => showCustomModal('More recipes coming soon!', 'info');
        if (document.getElementById('quickSearchDessert2')) document.getElementById('quickSearchDessert2').onclick = () => showCustomModal('More recipes coming soon!', 'info');


        // Re-attach serving buttons
        document.querySelectorAll('.serving-btn').forEach(button => {
            button.onclick = (e) => {
                const servings = parseInt(e.target.dataset.servings);
                updateIngredientsForServings(servings);
            };
        });

        // Re-attach custom servings input
        const customServingsInput = document.getElementById('customServings');
        if (customServingsInput) {
            customServingsInput.onchange = (e) => {
                const servings = parseInt(e.target.value);
                if (!isNaN(servings) && servings > 0) {
                    updateIngredientsForServings(servings);
                } else {
                    showCustomModal("Please enter a valid number of plates.", 'error');
                }
            };
        }

        // Re-attach ingredient click handlers
        document.querySelectorAll('.ingredient-card').forEach(ingredientCard => {
            ingredientCard.onclick = (e) => {
                const ingredientId = e.currentTarget.dataset.ingredientId;
                openProductModal(ingredientId);
            };
        });

        // Re-attach Add to Cart buttons in product modal
        document.querySelectorAll('.addToCartBtn').forEach(button => {
            button.onclick = (e) => {
                const ingredientId = e.currentTarget.dataset.ingredientId;
                const brandId = e.currentTarget.dataset.brandId;
                addToCart(ingredientId, brandId);
            };
        });

        if (closeProductModal) closeProductModal.onclick = closeProductModalFunc;

        if (document.getElementById('continueShoppingBtn')) document.getElementById('continueShoppingBtn').onclick = () => navigateTo('home');

        // Programmatically attach event listener for switching to signup form
        if (document.getElementById('switchToSignupBtn')) document.getElementById('switchToSignupBtn').onclick = showSignupForm;
        if (document.getElementById('backToRecipeBtn')) document.getElementById('backToRecipeBtn').onclick = () => navigateTo('home');


        // Add event listener for the new AI button
        if (generateAIButton) {
            generateAIButton.addEventListener('click', async () => {
                const prompt = "Explain how AI works in a few words"; // You can customize or get from user input
                if (aiResultDiv) {
                    aiResultDiv.textContent = 'Generating AI content...';
                }
                try {
                    let chatHistory = [];
                    chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                    const payload = { contents: chatHistory };
                    const apiKey = ""; // If you want to use models other than gemini-2.0-flash or imagen-3.0-generate-002, provide an API key here. Otherwise, leave this as-is.
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    console.log(`[Frontend] Sending AI request to: ${apiUrl}`); // New log
                    const response = await fetch(apiUrl, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                    const result = await response.json(); // Await the JSON parsing
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        if (aiResultDiv) {
                            aiResultDiv.textContent = text;
                        }
                    } else {
                        if (aiResultDiv) {
                            aiResultDiv.textContent = 'Failed to get AI response: Unexpected response structure.';
                        }
                    }
                } catch (err) {
                    console.error('[Frontend] Gemini API error:', err); // New log
                    if (aiResultDiv) {
                        aiResultDiv.textContent = 'Failed to get AI response: Network or API error.';
                    }
                }
            });
        }
    }


    // --- Authentication Functions ---
    async function fetchUserProfile(uid, dbInstance) {
        try {
            const userDocRef = doc(dbInstance, `artifacts/${appId}/users/${uid}/profile/data`);
            const docSnap = await getDoc(userDocRef);
            if (docSnap.exists()) {
                appState.currentUser = { id: uid, ...docSnap.data() };
                if (userNameElem) userNameElem.textContent = appState.currentUser.name;
                if (userGreeting) userGreeting.classList.remove('hidden');
                // These buttons are now handled by their IDs in attachEventListeners
                // if (authBtn) authBtn.classList.add('hidden');
                // if (profileBtn) profileBtn.classList.remove('hidden');
                if (makeAgainSection) makeAgainSection.classList.remove('hidden');
                if (popularRecipes) popularRecipes.classList.remove('hidden');
                // Ensure delivery address is updated for checkout modal
                if (appState.currentUser.deliveryAddress) {
                    appState.deliveryAddress = appState.currentUser.deliveryAddress;
                }
            } else {
                console.log("No such user profile document!");
                // Handle case where profile doesn't exist (e.g., new anonymous user)
                appState.currentUser = { id: uid, name: 'Guest', email: 'anonymous@example.com', address: 'Unknown' };
                if (userGreeting) userGreeting.classList.remove('hidden');
                if (userNameElem) userNameElem.textContent = appState.currentUser.name;
                // These buttons are now handled by their IDs in attachEventListeners
                // if (authBtn) authBtn.classList.add('hidden');
                // if (profileBtn) profileBtn.classList.remove('hidden');
            }
        } catch (error) {
            console.error("Error fetching user profile:", error);
            showCustomModal("Failed to load user profile.", 'error');
        }
    }

    function showAuthModal() {
        authModal.classList.remove('hidden');
        // Default to login tab
        showLoginForm();
    }

    function hideAuthModal() {
        authModal.classList.add('hidden');
    }

    function showLoginForm() {
    if (loginTab) {
        loginTab.classList.add('border-green-500', 'text-green-600');
        loginTab.classList.remove('text-gray-500');
    }
    if (signupTab) {
        signupTab.classList.remove('border-green-500', 'text-green-600');
        signupTab.classList.add('text-gray-500');
    }
    if (loginForm) loginForm.classList.remove('hidden');
    if (signupForm) signupForm.classList.add('hidden');
    currentPage = 'login'; // Update global state
    // Do NOT call renderApp() here
}


    function showSignupForm() {
    if (signupTab) {
        signupTab.classList.add('border-green-500', 'text-green-600');
        signupTab.classList.remove('text-gray-500');
    }
    if (loginTab) {
        loginTab.classList.remove('border-green-500', 'text-green-600');
        loginTab.classList.add('text-gray-500');
    }
    if (signupForm) signupForm.classList.remove('hidden');
    if (loginForm) loginForm.classList.add('hidden');
    currentPage = 'register'; // Update global state
    // Do NOT call renderApp() here
}

    function toggleGpsInput(event) {
        if (manualAddressSection) {
            if (event.target.checked) {
                manualAddressSection.classList.add('hidden');
                appState.showLocationPopup = true; // Show location popup
            } else {
                manualAddressSection.classList.remove('hidden');
                appState.showLocationPopup = false; // Hide location popup
            }
        }
        renderApp(); // Re-render to reflect changes
    }

    function enableLocation() {
        // Simulate GPS detection
        showCustomModal("Detecting location...", 'info');
        setTimeout(() => {
            appState.locationEnabled = true;
            appState.deliveryAddress = "123 Main St, Bengaluru, Karnataka, India"; // Mock GPS address
            appState.showLocationPopup = false;
            showCustomModal("Location detected!", 'success');
            // Update the address input if it exists
            const deliveryAddressInput = document.getElementById('deliveryAddressInput');
            if (deliveryAddressInput) {
                deliveryAddressInput.value = appState.deliveryAddress;
            }
            renderApp();
        }, 1500);
    }

    function skipLocation() {
        appState.showLocationPopup = false;
        appState.locationEnabled = false;
        if (manualAddressSection) manualAddressSection.classList.remove('hidden');
        const useGpsCheckbox = document.getElementById('useGps');
        if (useGpsCheckbox) useGpsCheckbox.checked = false;
        renderApp();
    }

    function hideLocationPopup() {
        appState.showLocationPopup = false;
        const useGpsCheckbox = document.getElementById('useGps');
        if (useGpsCheckbox) useGpsCheckbox.checked = false;
        if (manualAddressSection) manualAddressSection.classList.remove('hidden');
        renderApp();
    }

    async function handleLogin() {
    const emailInput = document.getElementById('loginEmail');
    const passwordInput = document.getElementById('loginPassword');
    const email = emailInput ? emailInput.value.trim() : ''; // Trim whitespace
    const password = passwordInput ? passwordInput.value : '';

    console.log(`[Frontend] Attempting login with email: '${email}' and password: '${password}'`); // New log with quotes

    if (!email || !password) {
        showCustomModal("Please enter both email and password.", 'error');
        return;
    }

    try {
        // Try admin login first via backend
        console.log(`[Frontend] Sending POST request to http://localhost:3000/login`); // New log
        const response = await fetch('http://localhost:3000/login', { // <--- CRITICAL CHANGE HERE
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
        });

        console.log(`[Frontend] Received response status for /login: ${response.status}`); // New log
        const result = await response.json();
        console.log('[Frontend] Login API response:', result); // New log

        if (response.ok && result.success && result.isAdmin) {
            console.log('[Frontend] Admin login successful, redirecting to /admin'); // New log
            window.location.href = 'http://localhost:3000/admin'; // <--- CRITICAL CHANGE HERE
            return;
        } else if (response.ok && result.success && !result.isAdmin) {
            console.log('[Frontend] Regular user login successful (via backend), attempting Firebase sign-in.'); // New log
            // If backend says it's a successful non-admin login, proceed with Firebase Auth
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                userId = user.uid;
                await fetchUserProfile(userId, db);
                hideAuthModal();
                showCustomModal("Logged in successfully!", 'success');
                navigateTo('home');
            } catch (firebaseError) {
                console.error("[Frontend] Firebase login fallback failed:", firebaseError); // New log
                showCustomModal(`Login failed with Firebase: ${firebaseError.message}`, 'error');
            }
        } else {
            console.error("[Frontend] Backend login failed or unexpected response:", result); // New log
            showCustomModal(`Login failed: ${result.message || 'Invalid credentials or server error.'}`, 'error');
        }
    } catch (error) {
        console.error('[Frontend] Network or unexpected error during login:', error); // New log
        showCustomModal("Login failed. Please check your network connection or try again later.", 'error');
    }
}

async function handleSignup() {
    const nameInput = document.getElementById('signupName');
    const emailInput = document.getElementById('signupEmail');
    const passwordInput = document.getElementById('signupPassword');
    const deliveryAddressInput = document.getElementById('deliveryAddressInput');

    const name = nameInput ? nameInput.value.trim() : '';
    const email = emailInput ? emailInput.value.trim() : '';
    const password = passwordInput ? passwordInput.value : '';
    let address = deliveryAddressInput ? deliveryAddressInput.value.trim() : '';

    if (!name || !email || !password || (!appState.locationEnabled && !address)) {
        showCustomModal("Please fill in all required fields (name, email, password, and delivery address).", 'error');
        return;
    }

    if (appState.locationEnabled) {
        address = appState.deliveryAddress; // Use GPS detected address
    }

    try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        userId = user.uid; // Set the global userId

        const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
        await setDoc(userDocRef, {
            name,
            email,
            deliveryAddress: address,
            createdAt: new Date(),
        });
        appState.currentUser = { name, email, deliveryAddress: address }; // <-- FIXED KEY
        hideAuthModal();
        showCustomModal("Account created successfully!", 'success');
        navigateTo('home');
    } catch (error) {
        console.error("Signup error:", error);
        showCustomModal(`Signup failed: ${error.message}`, 'error');
    }
}

    async function handleLogout() {
        if (auth) {
            try {
                await signOut(auth);
                appState.currentUser = null;
                userId = null;
                appState.cart = []; // Clear cart on logout
                showCustomModal("Logged out successfully.", 'info');
                navigateTo('home'); // Go to home/login state
            } catch (error) {
                console.error("Error logging out:", error);
                showCustomModal("Failed to log out.", 'error');
            }
        }
    }

    // --- Recipe and Ingredient Functions ---
    function handleDishSearchFromInput() {
        const searchTerm = recipeSearch ? recipeSearch.value.toLowerCase().trim() : '';
        if (searchTerm in recipesDatabase) {
            appState.currentRecipe = recipesDatabase[searchTerm];
            navigateTo('ingredients');
        } else {
            showCustomModal('Recipe not found. Try "panipuri" or "biryani".', 'info');
        }
    }

    function handleQuickSearch(recipeKey) {
        if (recipeKey in recipesDatabase) {
            appState.currentRecipe = recipesDatabase[recipeKey];
            navigateTo('ingredients');
        } else {
            showCustomModal('Recipe not found.', 'info');
        }
    }

    function openProductModal(ingredientId) {
        if (!appState.currentRecipe) {
            showCustomModal("Please select a recipe first.", 'info');
            return;
        }
        const ingredient = appState.currentRecipe.ingredients.find(ing => ing.id === ingredientId);
        if (ingredient) {
            appState.currentIngredient = ingredient;
            renderApp(); // Re-render to show the product modal
        } else {
            showCustomModal("Ingredient details not found.", 'error');
        }
    }

    function closeProductModalFunc() {
        appState.currentIngredient = null;
        renderApp(); // Re-render to hide the product modal
    }

    function addToCart(ingredientId, brandId) {
        const ingredient = appState.currentRecipe.ingredients.find(ing => ing.id === ingredientId);
        const brand = ingredient.brands.find(b => b.id === brandId);

        if (ingredient && brand) {
            const existingItemIndex = appState.cart.findIndex(item => item.id === brand.id);
            if (existingItemIndex !== -1) {
                // Update quantity if item already in cart
                appState.cart[existingItemIndex].quantity += (ingredient.quantityPerServing || 1); // Add based on recipe serving
            } else {
                // Add new item to cart
                appState.cart.push({
                    id: brand.id,
                    name: ingredient.name,
                    image: brand.image,
                    weight: brand.weight,
                    price: brand.price,
                    marketPrice: brand.marketPrice,
                    store: brand.store,
                    quantity: (ingredient.quantityPerServing || 1) // Default to 1 if not specified
                });
            }
            showCustomModal(`${ingredient.name} from ${brand.name} added to cart!`, 'success');
            closeProductModalFunc();
            updateCartCount();
            renderCartItems(); // Ensure cart sidebar updates
        } else {
            showCustomModal("Failed to add item to cart.", 'error');
        }
    }

    function closeCartSidebarFunc() {
        if (cartSidebar) cartSidebar.style.transform = 'translateX(100%)';
    }

    async function handlePlaceOrder() {
        if (appState.cart.length === 0) {
            showCustomModal("Your cart is empty. Please add items before placing an order.", 'info');
            return;
        }
        if (!db || !userId) {
            showCustomModal("Please log in to place an order.", 'error');
            return;
        }

        const { totalCost, totalSavings } = calculateCartSummary();
        const orderDetails = {
            userId: userId,
            userName: appState.currentUser?.name || 'Guest',
            userEmail: appState.currentUser?.email || 'N/A',
            deliveryAddress: appState.currentUser?.address || 'N/A',
            dishName: appState.currentRecipe?.name || 'Custom Order',
            orderedItems: JSON.parse(JSON.stringify(appState.cart)), // Deep copy to avoid reference issues
            totalCost: totalCost + 40, // Add delivery fee
            totalSavings: totalSavings,
            status: 'Pending',
            timestamp: new Date(),
        };

        try {
            const ordersColRef = collection(db, `artifacts/${appId}/public/data/orders`);
            const docRef = await addDoc(ordersColRef, orderDetails);
            appState.lastOrderId = docRef.id; // Store the new order ID
            appState.cart = []; // Clear the cart
            updateCartCount();
            appState.showCheckoutModal = true;
            // Set delivery time (next day 6 PM)
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(now.getDate() + 1);
            tomorrow.setHours(18, 0, 0, 0);

            const options = {
                weekday: 'long',
                hour: 'numeric',
                minute: 'numeric',
                hour12: true
            };
            if (deliveryTime) deliveryTime.textContent = tomorrow.toLocaleTimeString('en-IN', options);
            if (orderIdElem) orderIdElem.textContent = appState.lastOrderId;
            if (deliveryAddressElem && appState.currentUser && appState.currentUser.address) {
                deliveryAddressElem.textContent = appState.currentUser.address;
            }

            showCustomModal("Order placed successfully! We will process it within 24 hours.", 'success');
            renderApp(); // Re-render to show checkout modal and clear cart
        } catch (error) {
            console.error("Error placing order:", error);
            showCustomModal("Failed to place order. Please try again.", 'error');
        }
    }

    function showCheckoutModal() {
        appState.showCheckoutModal = true;
        renderApp();
    }

    function closeCheckoutModalFunc() {
        appState.showCheckoutModal = false;
        renderApp();
    }

    // --- Admin Functions ---
    function fetchOrders() {
        if (!db || !userId) return;

        const ordersColRef = collection(db, `artifacts/${appId}/public/data/orders`);
        const q = query(ordersColRef, orderBy("timestamp", "desc"));

        onSnapshot(q, (snapshot) => {
            appState.orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderApp(); // Re-render to update admin dashboard
        }, (error) => {
            console.error("Error fetching orders:", error);
            showCustomModal("Failed to load orders for admin dashboard.", 'error');
        });
    }

    // --- Navigation Function ---
    function navigateTo(page) {
    currentPage = page;
    appState.currentIngredient = null;
    appState.showCheckoutModal = false;
    appState.showLocationPopup = false;
    if (page === 'home') {
        appState.currentRecipe = null; // <-- This ensures the search bar is empty
        if (recipeSearch) recipeSearch.value = '';
    }
    renderApp();
}

    // --- Initialization ---
    window.onload = async () => {
        // Initialize Firebase services
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Authenticate user
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    await fetchUserProfile(userId, db);
                } else {
                    userId = null;
                    appState.currentUser = null;
                    currentPage = 'home'; // Go to home if not authenticated
                    renderApp();
                }
            });

            // If no user is logged in and no token, try anonymous sign-in
            if (!auth.currentUser && initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else if (!auth.currentUser) {
                await signInAnonymously(auth);
            }

        } catch (error) {
            console.error("Firebase initialization error:", error);
            showCustomModal("Failed to initialize Firebase. Please check your console for details and ensure Firebase config is correct.", 'error');
        }

        // Initial render
        renderApp();
    };
</script>
</body>
</html>
